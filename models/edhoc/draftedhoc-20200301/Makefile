MODEL=edhoc_model_draft20200301.pv
TEST=libTest.pv
LIB=edhoc_common.pvl

ERR=echo "SANITY FAILURE"
ORFAIL=grep "All well-formedness checks were successful" || (${ERR}; exit)
SRC=edhocM4.spthy
TAMARIN=tamarin-prover --quit-on-warning --heuristic=O --oraclename=oracle.py
TAMARIN_SANITY=${TAMARIN} --prove=sanity

MSIGSIG=-Dm4METHODI=SIG -Dm4METHODR=SIG
TSIGSIG=TMP_edhoc_SIG_SIG.spthy
MSIGSTAT=-Dm4METHODI=SIG -Dm4METHODR=STAT
TSIGSTAT=TMP_edhoc_SIG_STAT.spthy
MSTATSIG=-Dm4METHODI=STAT -Dm4METHODR=SIG
TSTATSIG=TMP_edhoc_STAT_SIG.spthy
MSTATSTAT=-Dm4METHODI=STAT -Dm4METHODR=STAT
TSTATSTAT=TMP_edhoc_STAT_STAT.spthy
MPSKPSK=-Dm4METHODI=PSK -Dm4METHODR=PSK
TPSKPSK=TMP_edhoc_PSK_PSK.spthy
MPASSIVE=-Dm4ATTACKER=PASSIVE
MACTIVE=-Dm4ATTACKER=ACTIVE

genModels:
	m4 ${MACTIVE} ${MSIGSTAT} ${SRC} > ACTIVE_${TSIGSTAT}
	m4 ${MACTIVE} ${MSTATSIG} ${SRC} > ACTIVE_${TSTATSIG}
	m4 ${MACTIVE} ${MSTATSTAT} ${SRC} > ACTIVE_${TSTATSTAT}
	m4 ${MACTIVE} ${MSIGSIG} ${SRC} > ACTIVE_${TSIGSIG}
	m4 ${MACTIVE} ${MPSKPSK} ${SRC} > ACTIVE_${TPSKPSK}
	m4 ${MPASSIVE} ${MSIGSTAT} ${SRC} > PASSIVE_${TSIGSTAT}
	m4 ${MPASSIVE} ${MSTATSIG} ${SRC} > PASSIVE_${TSTATSIG}
	m4 ${MPASSIVE} ${MSTATSTAT} ${SRC} > PASSIVE_${TSTATSTAT}
	m4 ${MPASSIVE} ${MSIGSIG} ${SRC} > PASSIVE_${TSIGSIG}
	m4 ${MPASSIVE} ${MPSKPSK} ${SRC} > PASSIVE_${TPSKPSK}

sense: genModels
	${TAMARIN} ${TSTATSIG} |& ${ORFAIL}
	${TAMARIN} ${TSIGSTAT} |& ${ORFAIL}
	${TAMARIN} ${TSTATSTAT} |& ${ORFAIL}
	${TAMARIN} ${TSIGSIG} |& ${ORFAIL}
	${TAMARIN} ${TPSKPSK} |& ${ORFAIL}

alotofsense: genModels
	${TAMARIN_SANITY} PASSIVE_${TSTATSIG} |& ${ORFAIL}
	${TAMARIN_SANITY} PASSIVE_${TSIGSTAT} |& ${ORFAIL}
	${TAMARIN_SANITY} PASSIVE_${TSTATSTAT} |& ${ORFAIL}
	${TAMARIN_SANITY} PASSIVE_${TSIGSIG} |& ${ORFAIL}
	${TAMARIN_SANITY} PASSIVE_${TPSKPSK} |& ${ORFAIL}

all:
	proverif ${LOADLIB} ${MODEL}

res:
	proverif ${LOADLIB} ${MODEL} | grep RESULT

tst:
	proverif ${LOADLIB} ${TEST}

