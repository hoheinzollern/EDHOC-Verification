% !TEX root =  edhocProtocol.tex
% Start the picture
\begin{tikzpicture}[%
    >=latex,              % Nice arrows; your taste may be different
    start chain=going below,    % General flow is top-to-bottom
    node distance=10mm and 60mm, % Global setup of box spacing
    every join/.style={norm},   % Default linetype for connecting boxes
    ]
% ------------------------------------------------- 
% A few box styles 
% <on chain> *and* <on grid> reduce the need for manual relative
% positioning of nodes
\tikzset{
terminput/.style={rounded corners, text width=6em},
term/.style={rounded corners},
  base/.style={draw, thick, on chain, on grid, align=center, minimum height=6ex},
  prk/.style={base, draw=Red3, fill=Red3!25, rectangle, text width=4em},
  %hkdfext/.style={base, draw=Green3, fill=Green3!25, isosceles triangle, isosceles triangle apex angle=60, anchor=base, shape border rotate=-90, text width=6em},
  hkdfext/.style={base, draw=Green3, fill=Green3!25, rectangle, text width=8em},
  %hkdfexp/.style={base, draw=orange, fill=orange!50, isosceles triangle, isosceles triangle apex angle=60, anchor=base, shape border rotate=-90, text width=6em},
  hkdfexp/.style={base, draw=orange, fill=orange!50, rectangle, text width=8em},
  keyb/.style={base, draw=Blue3, fill=Blue3!25, rectangle, text width=4em},
  % -------------------------------------------------
  norm/.style={->, draw, Blue3},
}
% -------------------------------------------------
% Start by placing the nodes
\node [prk] (p0) {$g^{xy}$};
\node [hkdfext, join] (h1) {\mHkdfExtract};
\node [prk, join] (p2) {\mPRKtwo};
\node [hkdfext, join] (h3) {\mHkdfExtract};
\node [prk, join] (p3) {\mPRKthree};
\node [hkdfext, join] (h5) {\mHkdfExtract};
\node [prk, join] (p4) {\mPRKfour};

\node [hkdfexp, shape border rotate=180, left= 3cm of p4] (h6) {\mHkdfExpand};
\node [keyb, join, left=3cm of h6] (k3) {\mKthreem};

\node [hkdfexp, shape border rotate=180, left= 3cm of p3] (h4) {\mHkdfExpand};
\node [keyb, join, left=3cm of h4] (k2) {\mKthreeae};

\node [hkdfexp, shape border rotate=180, left= 3cm of p2] (h2) {\mHkdfExpand};
\node [keyb, join, left=3cm of h2] (k1) {\mKtwoe};


\node [keyb, below=1cm of k2] (k2b) {\mKtwom};
%\node [draw=none, fill=none, below=0.5cm of h4] (dummy) {};

\draw [->, norm] (h4.south) -- ++(0,-0.58) -- (k2b);
\draw [->, norm] (p2) -- (h2); 
\draw [->, norm] (p3) -- (h4); 
\draw [->, norm] (p4) -- (h6);
%\node [term, fill=Green3!25, below = -1.3cm of h1] (h1name) {\mHkdfExtract};
%\node [term, left = 1cm of h1name] (u1) {H1};
%\draw [->, dotted, shorten >=1mm] (u1) -- (h1name);
\node [terminput, right = 1cm of h1] (u1) {Initial salt};
\draw [->, dotted, shorten >=1mm] (u1) -- (h1);

%\node [term, fill=Green3!25, below = -1.3cm of h3] (h3name) {\mHkdfExtract};
%\node [term, left = 1cm of h3name] (u2) {H2};
%\draw [->, dotted, shorten >=1mm] (u2) -- (h3name);
\node [terminput, right = 1cm of h3] (u2) {Additional input};
\draw [->, dotted, shorten >=1mm] (u2) -- (h3);

\node [terminput, right = 1cm of h5] (u3) {Additional input};
\draw [->, dotted, shorten >=1mm] (u3) -- (h5);


%\node [term, fill=orange!50, below = -0.9cm of h2] (h2name) {\mHkdfExpand};
%\node [term, above = 1cm of h2name] (u3) {H3};
%\draw [->, dotted, shorten >=1mm] (u3) -- (h2);
\node [term, above = 1cm of h2] (u4) {\mTHtwo};
\draw [->, dotted, shorten >=1mm] (u4) -- (h2);

%\node [term, fill=orange!50, below = -0.9cm of h4] (h4name) {\mHkdfExpand};
%\node [term, above = 1cm of h4name] (u5) {H5};
%\draw [->, dotted, shorten >=1mm] (u5) -- (h4);
\node [term, above = 1cm of h4] (u5) {\mTHtwo};
\draw [->, dotted, shorten >=1mm] (u5) -- (h4);

\node [term, above = 1cm of h6] (u6) {\mTHthree};
\draw [->, dotted, shorten >=1mm] (u6) -- (h6);

%
% ------------------------------------------------- 
% 
%\path (h2.east) to node [near start, yshift=1em] {$n$} (c3); 
%  \draw [o->,lccong] (h2.east) -- (p8);
%\path (p3.east) to node [yshift=-1em] {$k \leq 0$} (c4r); 
%  \draw [o->,lcnorm] (p3.east) -- (p9);
% -------------------------------------------------
% 
%\path (h1.east) to node [near start, yshift=1em] {$n$} (c1); 
%  \draw [o->,lcfree] (h1.east) -- (c1) |- (p4);
%\path (h3.east) -| node [very near start, yshift=1em] {$n$} (c1); 
%  \draw [o->,lcfree] (h3.east) -| (c1);
%\path (p3.west) to node [yshift=-1em] {$k>0$} (c4); 
%  \draw [*->,lcnorm] (p3.west) -- (c4) |- (p3);
%\path (h4.east) -| node [very near start, yshift=1em] {$n$} (c6); 
%  \draw [o->,lcfree] (h4.east) -| (c6); 
%\path (h5.east) to node [near start, yshift=1em] {$n$} (c6); 
%  \draw [o->,lcfree] (h5.east) -| (c7); 
%\path (p4.east) to node [yshift=-1em] {$k \leq 0$} (c7); 
%  \draw [o->,lcfree] (p4.east) -- (c7)  |- (p9);
%\path (p4.west) to node [yshift=-1em] {$k>0$} (c5); 
%  \draw [*->,lcfree] (p4.west) -- (c5) |- (p5);
% -------------------------------------------------
% A last flourish which breaks all the rules
%\draw [->,MediumPurple4, dotted, thick, shorten >=1mm]
%  (p9.south) -- ++(5mm,-3mm)  -- ++(27mm,0) 
%  |- node [black, near end, yshift=0.75em, it]
%    {(When message + resources available)} (p0);
% -------------------------------------------------
\end{tikzpicture}
% =================================================
