% !TEX TS-program = pdflatexmk

\documentclass[runningheads, envcountsame, a4paper, draft, x11names]{llncs}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage[scaled=0.8]{helvet}    % Less huge \textsf{functionName}
%\usepackage{enumitem}       % compacts lists and stuff
%\usepackage[subtle]{savetrees}
\usepackage{soul}           % \hl for highlighting text; \st for strike-through
\usepackage{graphicx}
\usepackage[dvipsnames]{xcolor}
%\usepackage{wrapfig}
\usepackage{tikz}
\usetikzlibrary{trees,snakes,arrows}
\usetikzlibrary{shapes,chains}
\usetikzlibrary{positioning}
\usepackage{url}
\usepackage{hyperref}
\hypersetup{
    final, % Uncomment to remove all links (useful for printing in black and white)
    colorlinks=true, breaklinks=true, bookmarks=false,bookmarksnumbered,
    urlcolor=blue, linkcolor=black, citecolor=green, % Link colors
    pdfkeywords={}, % PDF Keywords
    pdfcreator={PdfLaTeX}, % PDF Creator
  }


\input{macros}
%%%%%% HACKY COMMAND FOR VSPACE, REMOVE AT END %%%%%
\setlength{\belowcaptionskip}{-10pt}
\newcommand{\spacehack}{\vspace{-1em}}
\newcommand{\fillhack}{\vspace{-0.5em}}


\begin{document}
\title{Formal Analysis of EDHOC Key Establishment for Constrained IoT Devices}
\author{Karl Norrman\inst{1,2}\orcidID{0000-0003-0164-1478} \and
Vaishnavi Sundararajan\inst{3} \and
Alessandro Bruni\inst{4}
}
%
\authorrunning{K. Norrman et al.}
% First names are abbreviated in the running head.
% If there are more than two authors, 'et al.' is used.
%
\institute{
    KTH Royal Institute of Technology, Stockholm, Sweden \and
    Ericsson Research, Security, Stockholm, Sweden,
    \email{karl.norrman@ericsson.com} \and
    Ericsson Research, Int. Auton. Systems, Bangalore, India, \email{vaishnavi.sundararajan} \and
    IT University of Copenhagen, Copenhagen, Denmark, \email{brun@itu.dk}
}
%
\maketitle
%

\begin{abstract}
%\hl{250 words}
    IETF is standardizing a key establishment protocol named \mEdhoc{} for
constrained IoT devices~\cite{selander-lake-edhoc-01}.
%
In contrast to more powerful devices like web cameras and cars, which receive a
lot of media attention, such devices operate under severe energy consumption
and message size restrictions.
%
A version of \mEdhoc{} was first formally analyzed in 2018 by
Bruni~et~al.~\cite{DBLP:conf/secsr/BruniJPS18}.
%
Since then, the protocol has been significantly extended and is now a
framework with five key establishment methods, of which three are new.
%
In this paper we formally analyze all methods of \mEdhoc{} in a symbolic
Dolev-Yao model, using the \mTamarin{} verification tool.
%
We show that the different methods provide sensible, but also rather
heterogeneous security properties, and discuss various consequences of this.
%
Our work has also led to improvements in the design and the specification of
\mEdhoc.
%
\end{abstract}
%

%-------------------------------------------------------------------------- sec
\vspace{-2.5em}
\section{Introduction}
\label{sec:introduction}
\fillhack
%-------------------------------------------------------------------------- sub
\subsection{Background and motivation}
\label{sec:motivation}
\fillhack
IoT security threats involving cars, web-cameras and similar devices
receive the most attention from media and academia.
%
These devices are computationally strong with no severe bandwidth or energy
consumption restrictions.
%
Securing the communication between such devices can readily be done using
existing protocols like \mDandTls.
%
Constrained devices, on the other hand, on which bandwidth and
energy consumption restrictions are common, have received much less attention.
%
These devices may be simple sensors with the only task of relaying
measurements of their physical environment to a server every hour, but doing so
autonomously for a decade without maintenance.
%
To keep energy consumption down, highly specialized radio links with small
and heterogeneous frame sizes are sometimes used.
%
IETF defined the Constrained Application Protocol (\mCoap{}) protocol for data
transport in such situations~\cite{rfc7252}.
%
\mCoap{} does not include security protection on its own, and in some cases,
\mDandTls{} messages are too large to fit into the radio frames.
%
%This is one of the reasons (KARL: GÃ¶ran complained earlier that this was not
%the only reason, so "one of" is correct. Maybe we there is a better phrasing
%though)
This is one of the reasons, IETF standardized the Object Security for
Constrained RESTful Environments (\mOscore{}) protocol to secure
communications between constrained devices, as a complement for when
\mDandTls{} is too heavyweight~\cite{rfc8613}.
%

The \mOscore{} protocol requires a pre-established security context.
%
For a couple of years, the IETF Lightweight Authenticated Key Exchange (LAKE)
working group has been developing requirements and mechanisms for a key
exchange protocol, named \mEdhoc~\cite{selander-lake-edhoc-01}, capable of
establishing \mOscore{} security contexts.
%
Naturally, \mEdhoc{} must work under the same constrained requirements as
\mOscore{} itself.
%

While use cases for \mEdhoc{} are not firmly set, the overall goal of \mEdhoc{}
is to establish an \mOscore{} security context, with message size limitations
driving the design.
%
Discussions on the LAKE working group mailing list explored whether
\mCtls~\cite{ietf-tls-ctls-00}, a compressed version of \mTls, would suffice
for the same situations that the combination of \mOscore{} and \mEdhoc{} aim
for.
%
The resulting consensus was to develop \mEdhoc{} in parallel with the
development of \mCtls{} by the \mTls{} working groups.
%

The \mEdhoc{} protocol has evolved significantly over time to cater for smaller
messages and more use cases.
%
The first incarnation of \mEdhoc{} appeared in March 2016.
%
It contained two different key establishment methods, one based on a
pre-shared Diffie-Hellman (DH) cryptographic core and a second based on a
variant of challenge-response signatures, in the style of the \mNoise{}
framework~\cite{perrin2016noise}.
%
By cryptographic core, or just core, we mean an academic cryptographic protocol,
lacking the encodings and application specific details required by an industrial
protocol.
%
By key establishment method, we mean a cryptographic core with those details
added.
%
The core based on challenge-repsonse signatures was then replaced by \mSigma{}
in May 2018, and this version was formally analyzed by
Bruni~et~al.~\cite{DBLP:conf/secsr/BruniJPS18}.
%
Now, variants using challenge-response signatures have been added again by
integrating the cryptographic core of \mOptls{}.
%
Additionally, mixed variants where one party uses a challenge-response
signature and the other a regular signature have also been added.
%
Consequently, there are now five methods in total, and formal analysis is
required to verify security guarantees for \mEdhoc.
%
This is especially important, since the \mSpec{} itself lacks a description
of the intended security model and overall security goals.
%
Discussing how this gap can be filled, and how to identify what the expected
security goals should be, is an important part of this paper (see
Section~\ref{sec:discussion}.
%

%-------------------------------------------------------------------------- sub
\spacehack
\subsection{Contributions}
\label{sec:contributions}
\fillhack
We formally analyze the \mEdhoc{} protocol, which has continuously evolved,
at times based on our feedback.
%
%The analysis spanned roughly five months, but t
The formal models and proven properties are based on the version as on 2020-03-01~\cite{selander-lake-edhoc-01}.
%x
Our main contributions are as follows.
\begin{itemize}
    %\item We formally analyze all five methods of \mEdhoc{} using \mTamarin~\cite{DBLP:conf/cav/MeierSCB13}.
    \item We give an explicit security model for the protocol and verify
        essential security properties, such as session key and entity
        authentication, as well as Perfect Forward Secrecy (PFS), within that
        model, for all five methods of \mEdhoc.
        \knote{The above item should contain the most impressive properties.
               Revise when Section 3 is completed}
        The formal analysis is done using \mTamarin~\cite{DBLP:conf/cav/MeierSCB13}.
    \item We discuss the relation between proven properties, potentially missing
        properties and the lack of clear design goals and security model for
        \mEdhoc{}.
        Based on this we give recommendations for future standards development.
    \item Our discussions with participants of the IETF LAKE working group have
        already lead to improvements and clarifications of the standard
        based on observations we made during the construction of our
        formal model.  We discuss these in Section~\ref{sec:discussion}.
        \knote{Now I understand your comment on Teams. Even though the word
            "standard" in the above item is the same document we later on call
            \mSpec{}, I think "standard" is an important signaling word we
            should use here to clarify the importance. I removed the word
            "\mSpec{}" above.}
\end{itemize}

%-------------------------------------------------------------------------- sub
\spacehack
\subsection{Related work}
\label{sec:relatedWork}
\fillhack
The work closest to ours is Bruni~et~al.~\cite{DBLP:conf/secsr/BruniJPS18},
which used \mProverif~\cite{DBLP:conf/csfw/Blanchet01} to analyze an earlier
version of \mEdhoc{} with only two methods. %~\cite{selander-ace-cose-ecdhe-08}.
\knote{Should we not reference the earlier version?  Not sure what the citation
is deleted.}
%
We consider our work to follow the same trajectory as that, performing a
similar kind of analysis of the most recent fiver-method version of \mEdhoc{}.
%
Some of the cryptographic cores that \mEdhoc{} uses have been analyzed in the
computational model, e.g., \mSigma{}~\cite{DBLP:conf/crypto/CanettiK02},
\mOptls{}~\cite{DBLP:conf/eurosp/KrawczykW16}, and
\mNoise{}~\cite{DBLP:conf/eurosp/KobeissiNB19}.
%
Computational models often rely on implicit session key authentication
(see, for example, the definition of SK-security in the Canetti-Krawczyk
model~\cite{DBLP:conf/crypto/CanettiK02}).
%
Although symbolic models predominantly rely on correspondence properties
in the style of Lowe~\cite{DBLP:conf/csfw/Lowe97a},
there are examples where implicit session key authentication has been used.
\knote{I think this is important to mention Lowe's paper given our discussion
    Wednesday about trace properties vs correspondence properties. It is not
    super clear even to formal methodologists :-).
    We also give quite a bit of details copied from that document in
    Section 3, so the document deserves being mentioned on a high-level already
here.}
%
For example, Schmidt~et~al.~\cite{DBLP:conf/csfw/SchmidtMCB12} use a
symbolized version of an extended Canetti-Krawzcyk model.
%

%-------------------------------------------------------------------------- sec
\spacehack
\section{The \mEdhoc{} protocol}
\label{sec:edhoc}
\input{edhocProtocol}

%-------------------------------------------------------------------------- sec
\spacehack
\section{Formalization and results}
\label{sec:formalization}
\input{edhocFormalization}

%-------------------------------------------------------------------------- sec
\spacehack
\section{Discussion}
\label{sec:discussion}
\fillhack
\knote{Please do not remove the latex formatting with a percentage sign
    separating sentences in the source code and keeping lines below 80
    characters.  That formatting makes it so much easier to see when sentences
    become too long, and most importantly: it makes it easier to see differences
    between commits.  When one line is an entire paragraph that is much more
    painful.
}
There are a few instances where things are ill-specified in the \mSpec{},
which we found as part of this work. We discuss them below.
%
\spacehack

%-------------------------------------------------------------------------- sub
\subsection{Security claim justification}
\label{sec:securityClaims}
\fillhack
The \mSpec{} makes detailed claims about security properties that \mEdhoc{}
enjoys, which the authors assume hold because they reuse cryptographic cores
from existing academic protocols.
%
Specifically, in Section~8.1 of~\cite{selander-lake-edhoc-01}, the authors
claim that ``EDHOC inherits its security properties from the theoretical
SIGMA-I''.
%
The intention is the same for the other reused cryptographic
cores based on \mOptls{} and \mNoise{}, but since the \mSpec{} is still work in
progress, it is not yet written down (personal correspondence with the authors).
%

While it is good practice to reuse well-studied academic components in
industrial standards, it is important to justify that changes made to these
components preserve security properties.
%
Some properties have been verified~\cite{DBLP:conf/secsr/BruniJPS18} and the
present paper verifies more, but until some justification is provided, security
claims may benefit from note of caution.
\spacehack
\knote{Specifically, our paper  shouldn't just point out that something is
wrong. We should constructively propose solutions to problems.}

%-------------------------------------------------------------------------- sub
\subsection{Lack of clear intended use}
\label{sec:unclearProtocolUse}
\fillhack
\knote{I added comments in the text prefixed by the keywoard "meta" to show
    The intended flow in case future revisions copy/paste single sentences
    between sections. Please check that the flow still makes sense if doing
    that, or change the flow to a new one.
}
% meta: FM clashes with ind. std. Also for EDHOC
Formal verification methodologies often clash with industrial standard
development practices; this is true also in our case.
%
% meta: This is the most important way they clash
The most important reason for the clash is that formal verification aims to
verify whether well-specified security goals are met, whereas industrial
standards are developed with a clear abstract goal,
but one that lacks specificity.
%
% meta: EDHOC tries to remedy this to some degree by listing specific goals from
% academic papers
Granted, as discussed in Section~\ref{sec:claimedProperties}, the \mSpec{} lists
several specific security goals, e.g., KCI and identity protection.
% meta: ...but that is insufficient
However, without knowing how the protocol is to be used
it is not clear whether these are important in the form they are listed.
%

% meta: This is the specific way in which EDHOC clashes and the consequences of that
The abstract goal of \mEdhoc{} is simple: establish an \mOscore{} security
context using few roundtrips and small messages.
%
% meta: The specifics of the abstract goal follows from restrictions
Starting from there, the design of \mEdhoc{} is mainly driven by what
can be achieved given certain technical restrictions.
%
% meta: That design philosophy does not take the use of the protocol into
% account -> % risk leading to insecure results
Focusing too much on what can be achieved within given restrictions, and paying
too little attention to the use cases with which the
protocol is to be used, risks resulting in making sub-optimal trade-offs and
design decisions.
%

% EDHOC aims to be generic, but some typical use cases can still be defined
\mEdhoc{} is intended for a variety of use cases, many of which are not
known today.
%
This intention does not prevent collecting a variety of \emph{typical}
use cases and user stories to identify more specific security goals.
%

% To decided which properties we should verify we identified some use cases.
While constructing our model, we came up with simple user stories to identify
security properties of interest.
%
% These use cases revealed undefined aspects in the spec
Several of these revealed undefined aspects of \mEdhoc{}.
%
% The aspects were then covered by EDHOC spec
We informed \mEdhoc{} authors and they included these aspects the \mSpec{}.
%
We now present a couple of examples.
%

\spacehack
\subsubsection{Non-repudiation}
An access control solution for a nuclear power-plant may need to log who is
passing through a door, whereas it may be undesirable for, say, a coffee
machine to log a list of users along with their coffee preferences.
%
Via this simple thought experiment, we realized that the \mSpec{} did not
consider non-repudiation.
%
In response, the authors of the \mSpec{} added a paragraph about which methods
provided which types of (non)-repudiation~\cite{personalCommunication}.

\spacehack
\subsubsection{Unintended peer authentication}
Section 3.2 of the \mSpec{} states that parties must be configured
with a policy restricting the set of peers they can run \mEdhoc{} with.
%
However, the initiator is not required to verify that the \mIdcredr{} received
in the second message is the same as the one intended at initialization.
%
The following thought experiment shows why such a policy is insufficient.
%

Assume that someone has configured all devices in their home to be in the
allowed set of devices, but that one of the devices ($A$) is compromised.
%
If another device $B$, initiates a connection to a third device $C$, the
compromised device $A$ may interfere by responding in $C$'s place, blocking
the legitimate response from $C$.
%
Since $B$ does not verify that the received identity in the second message
matches the intended identity $C$, and device $A$ is part of the allowed set,
$B$ will complete and accept the \mEdhoc{} run with device $A$ instead of the
intended $C$.
%
The obvious solution is for the initiator to match \mIdcredr{} to the intended
identity provided by the application.
%
We have communicated this situation to the \mEdhoc{} authors and they consider
how to resolve the issue.
%

%------------------------------------------------------------------------- sub
\subsection{Unclear security model}
When designing a security protocol, the attacker's capabilities must be
considered so that it is possible to determine whether the protocol is
sufficiently secure.
%
That is, a security model in which the protocol is deemed
secure needs to be defined at least on a high level.
%
We argue that the \mSpec{} gives too little information about what capabilities
an attacker is assumed to have, and that this leads to unclear design goals and
possibly a sub-optimal design.
%
Let us explore this via an example.
%

It is conceivable that IoT devices deployed in a hostile environments can be
hardened by equipping them with a TEE, but \mEdhoc{} is not intentionally
designed to take advantage of this.
%
Even though \mEdhoc{} incorporates cryptographic cores from different academic
security protocols, its design does not take into account the attacker models
for which these protocols were designed.
%
For example, \mOptls{} is designed to be secure in the CK
model~\cite{DBLP:conf/crypto/CanettiK02}.
%
The CK security model explicitly separates the secure storage of long-term
credentials from storage of session state and ephemeral keys to model
use of TEEs.
%

The \mEdhoc{} authors indicated to us that it was
not necessary to consider compromised ephemeral session keys separately from
from compromised long-term keys~\cite{personalCommunication}. 
%
The rationale is that \mSigma{} cannot protect against compromised ephemeral
keys.
%
That rationale is presumably based on that the \mSigSig{} method is
closely modeled on \mSigmaI{} and that it would be preferable to obtain a
homogeneous security level among the \mEdhoc{}
methods\cite{personalCommunication}.
\vnote{Speculation?}
\knote{To some degree. I cannot be certain about what the rationale was based
    on. I can only write what they have replied in mails. I could have
misinterpreted that. The rationale as such is not speculation though.}
%
That rationale is only true, however, if one restricts attention to session key
confidentiality of an ongoing session.
%
TEEs provide value in other ways, for example, by allowing contractions with 
weak PCS guarantees.
%
It would be wasteful to not consider TEEs for long-term key storage as part of
the security, since it would otherwise make use of many good properties of the
re-used cryptographic cores.
%
For example, coming back to \mOptls{}, which was intentionally
designed to be provably secure in the CK model.
%

%-------------------------------------------------------------------------- sub
\spacehack
\subsection{Session key material}
\label{sec:sessionKeyMaterial}
\fillhack
\mEdhoc{} establishes a session key state as output, from which session keys
for \mOscore{} can be derived using \mHkdf{}.
%
As discussed in Section~\ref{sec:threat-model}, there are various possibilities
for defining which parameters from the \mEdhoc{} run should be included in the
session key state.
%

While we show bidirectional injective agreement on \mGx{} and \mGy{}
for all methods, initiators cannot obtain injective agreement on \mGiy{} when
using the \mStat{} method themselves. Therefore, \mGiy{} cannot be considered
part of the key material if mutual injective agreement is considered important.
%
Excluding \mGiy{} would deviate from \mOptls{}, which is the cryptographic core
used for the \mStat-based methods. Specifically, the proof of session key
confidentiality in the face of long-term key compromise for \mOptls{} cannot be
adapted for \mEdhoc{}.
%
Other security properties of \mOptls{} may also fail to be true if
\mGiy{} were excluded. \vnote{Conjecture.}
\knote{Correct. The logic is the same as when we want to give at least one
    example to show that \mEdhoc{} is different from \mNoise{} and therefore the
proofs of \mNoise{} does not carry over to \mEdhoc{}. }
%

=>>> flow broken by copy/paste FIXME
This can be avoided by including a fourth message from responder to initiator
carrying a message authentication code using a key derived from session key
material including \mGiy{}.
%
This would give the initiator sufficient guarantees about the same \mGiy{}
being used by the responder as well.
%
However, the cost is an additional message, and our understanding is that this
is unacceptable (personal correspondence with the \mSpec{} authors).
%
In some use cases there could be a such as message as part of
the subsequent \mOscore{} protocol run. It would, however, create an additional
dependency between the two protocols, increasing complexity and the risk of
insecure implementations.
%

Yet another option is to include \mGi{}, or a hash of it, in the first and
second message.
%
This would, however, increase message sizes, a grave concern for \mEdhoc{},
and would also prevent initiator identity protection.
%
While identity protection is important in general, neither the \mSpec{} nor
the requirements document give any rationale why one identity (the intiator's)
is deemed more important (and needs protection) than the other
(the responder's).
%

The \mSpec{} states that the initiator's identity is protected against active
attacks and the responder's against passive attacks, but that the roles should
be assigned to the \mCoap{} peers to protect the most sensitive identity the
most (see Section~8~\cite{selander-lake-edhoc-01}).
%
Roles could hence be swapped, so identity protection is not a strong argument
against this option.
%
So perhaps this method can be used to obtain injective agreement on \mGiy.
%
\knote{If I did not uncomment the first two sentences in the paragraph above,
the last sentence made no sense on its own. I believe the idea is important,
because it gives a suggestion on how standardization may proceed if they
actually want inj-agree on \mGiy. We want to propose solutions, not just point
out problems.}
%

In this work, we have shown implicit agreement on \mGx{}, \mGy{} for all
methods, and also on \mGiy{} and \mGrx{} when these are used,
see Section~\ref{sec:formalization}.
%
If this weaker security guarantee is sufficient, both ephemeral and long-term
keys can be part of the session key material.
%
However, this also depends on the intended use of \mEdhoc{}.
%

%-------------------------------------------------------------------------- sub
\spacehack
\subsection{Cipher suite negotiation}
\label{sec:ciphersuiteNegotiation}
\fillhack
\knote{If we are tight on space, we can consider removing this section since we
    don't verify any negotiation. We did have impact on the \mEdhoc{} \mSpec
    with this though.
}
%
Cipher suite negotiation in \mEdhoc{} spans two or more executions of the
protocol.
%
If a run terminates due to the proposed cipher suites being rejected by the
responder, the initiator maintains state and initiates a new run, proposing
an updated set of cipher suites (see Section~\ref{sec:edhoc}).
%
Our model does not cover this, and we leave it for future work.

Maintaining state between protocol runs implicitly creates a long-lived
meta-session covering multiple \mEdhoc{} sessions.
%
Such a meta-session is presumably controlled by the underlying application.
%
However, the \mSpec{} does not specify the time for which the initiator should
remember a rejected cipher suite for a given responder.
%

From a security perspective, remembering the rejected cipher suite for the
next \mEdhoc{} run in the same meta-session would be sufficient.
%
If the responder is updated with a new cipher suite before the next such
session, this could be taken into account. On the other hand, caching the
rejected cipher suite between meta-sessions would reduce the number of
round-trips for subsequent runs, should the responder not have been updated.
%
This needs to be clearly specified. 

%-------------------------------------------------------------------------- sec
\spacehack
\section{Conclusions}
\label{sec:conclusions}
\fillhack
We have formally modeled all five
methods of the \mEdhoc{} key establishment protocol using the \mTamarin{} tool.
%
We formulated and verified several important security properties in this model. 
%
%We also identified security properties that do not hold for all methods.
%
Most importantly, we found that injective agreement on \mGiy{} does not hold for
initiators when they use the \mStat{} method.
%
Further, we identified a situation where initiators may establish an \mOscore{} security context with a different party than the application using \mEdhoc{} intended, and proposed a simple mitigation.
%
We discussed how the IETF may extract and better define security properties to enable easier verification.
%

%-------------------------------------------------------------------------- ack
% Should be a run-in heading.  subsubsection works in llncs2e document class
\spacehack
\subsubsection*{Acknowledgments} This work was partially supported by
the Wallenberg AI, Autonomous Systems and Software Program (WASP) funded by
the Knut and Alice Wallenberg Foundation.
%
We are grateful to G\"oran Selander, John Mattsson and Francesca Palombini for
clarifications regarding the specification.
%
\spacehack
%-------------------------------------------------------------------------- bib
\bibliographystyle{abbrv}
\bibliography{ref}
\end{document}
