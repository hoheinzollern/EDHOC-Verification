\documentclass[runningheads,draft,x11names]{llncs}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage[scaled=0.8]{helvet}    % Less huge \textsf{functionName}
\usepackage{enumitem}       % compacts lists and stuff
\usepackage[subtle]{savetrees}
\usepackage{soul}           % \hl for highlighting text; \st for strike-through
\usepackage{graphicx}
\usepackage[dvipsnames]{xcolor}
\usepackage{wrapfig}
\usepackage{tikz}
\usetikzlibrary{trees,snakes,arrows}
\usetikzlibrary{shapes,chains}
\usetikzlibrary{positioning}
\usepackage{url}
\usepackage{hyperref}
\hypersetup{
    final, % Uncomment to remove all links (useful for printing in black and white)
    colorlinks=true, breaklinks=true, bookmarks=false,bookmarksnumbered,
    urlcolor=blue, linkcolor=black, citecolor=green, % Link colors
    pdfkeywords={}, % PDF Keywords
    pdfcreator={PdfLaTeX}, % PDF Creator
  }

\input{macros}

\begin{document}
\title{Formal Analysis of EDHOC Key Establishment for Constrained IoT Devices}
\author{Karl Norrman\inst{1,2}\orcidID{0000-0003-0164-1478} \and
Vaishnavi Sundararajan\inst{3} \and
Alessandro Bruni\inst{4}
}
%
\authorrunning{K. Norrman et al.}
% First names are abbreviated in the running head.
% If there are more than two authors, 'et al.' is used.
%
\institute{
    KTH Royal Institute of Technology, Stockholm, Sweden \and
    Ericsson Research, Security, Stockholm, Sweden,
    \email{karl.norrman@ericsson.com} \and
    Ericsson Research, Int. Auton. Systems, Bangalore, India, \email{vaishnavi.sundararajan} \and
    IT University of Copenhagen, Copenhagen, Denmark, \email{brun@itu.dk}
}
%
\maketitle
%

\begin{abstract}
%\hl{250 words}
    IETF is standardizing a key establishment protocol named \mEdhoc{} for
constrained IoT devices~\cite{selander-lake-edhoc-01}.
%
In contrast to more powerful IoT devices, such as web cameras and cars,
which receive most attention from media, constrained devices often have severe
restrictions on energy consumption.
%
Additionally, they often use specialized wireless communication links with
demanding constraints on message sizes, which may also vary between messages.
%
\mEdhoc{} was first formally analyzed by
Bruni~et.~al.~\cite{DBLP:conf/secsr/BruniJPS18}.
%
Since then, the protocol has been significantly extended and is now a
framework with a number of cryptographic cores, called methods.
%
The initial version of \mEdhoc{} contained only two out of the current five
methods~\cite{selander-ace-cose-ecdhe-08}.
%
In this paper we formally analyze all methods of \mEdhoc{} in a symbolic
Dolev-Yao model, using the \mTamarin{} verification tool.
%
We show that the different methods provide sensible, but also rather
heterogeneous security properties, and discuss consequences of this.
%
\end{abstract}
%

%-------------------------------------------------------------------------- sec
\section{Introduction}
\label{sec:introduction}
%-------------------------------------------------------------------------- sub
\subsection{Background and motivation}
\label{sec:motivation}
IoT security threats involving cars, web-cameras and other resourceful devices
receive most attention from media and academia.
%
These devices are computationally strong with no severe bandwidth or energy
consumption restrictions.
%
Securing the communication between such devices can readily be done using
\mDandTls.
%
Constrained devices, on the other hand, on which bandwidth and
energy consumption restrictions are common, have received much less attention.
%
These devices may be simple sensors with the only task of relaying
measurements of their physical environment to a server every hour, but doing so
autonomously for a decade without maintenance.
%
To keep energy consumption down, highly specialized radio links with small
and heterogeneous frame sizes are sometimes used.
%
IETF defined the Constrained Application Protocol (\mCoap{}) protocol for data
transport in such situations~\cite{rfc7252}.
%
\mCoap{} does not include security protection on its own.
%
In some cases, \mDandTls{} messages are too large to fit into the radio frames.
%
This is one of the reasons IETF standardized the Object Security for
Constrained RESTful Environments (\mOscore{}) protocol to secure
communications between constrained devices, as a complement for when
\mDandTls{} is too heavy weight~\cite{rfc8613}.
%

The \mOscore{} protocol requires a pre-established security context.
%
For a couple of years, the IETF Lightweight Authenticated Key Exchange (LAKE)
working group has been developing requirements and mechanisms for a key
exchange protocol, named \mEdhoc~\cite{selander-lake-edhoc-01}, capable of
establishing \mOscore{} security contexts.
%
Naturally, \mEdhoc{} must work under the same constrained requirements as
\mOscore{} itself.
%

While use cases for \mEdhoc{} are not firmly set,
the overall goal of \mEdhoc{} is to establish an \mOscore{} security
context, keeping messages small being the most prominent driver for the
design.
%
Discussions on the LAKE working group mailing list explored whether a
compressed version of \mTls, named \mCtls~\cite{ietf-tls-ctls-00}, would suffice
for the same situations that
the combination of \mOscore{} and \mEdhoc{} aim for.
%
They concluded to proceed developing \mEdhoc{} in parallel to the \mTls{}
working groups efforts to develop \mCtls.
%

The \mEdhoc{} protocol has evolved significantly over time to cater for smaller
messages and more use cases.
%
The first incarnation of \mEdhoc{} appeared in March 2016.
%
It contained two different cryptographic cores, one based on a
pre-shared Diffie-Hellman (DH) key and a second following a draft of the
challenge-response signatures, in the style of the \mNoise{}
framework~\cite{perrin2016noise}.
%
The latter was then replaced by \mSigma, and this version, from May 2018, was
formally analyzed by Bruni~et.~al.~\cite{DBLP:conf/secsr/BruniJPS18}.
%
The protocol has now further evolved and variants using challenge-response
signatures have been added again by integrating the cryptographic core of
\mOptls{}.
%
On top of this, mixed variants where one party uses a challenge-response
signature and the other a regular signature have also been added.
%
Consequently, there are now five cryptographic cores in total, and it is prudent
to formally analyze them all to ensure a higher level of security assurance for
\mEdhoc.
%
This is especially important, since the \mSpec{} itself lacks a description
of the intended security model and overall security goals.
%
Discussing how this gap can be filled, and how to identify what the expected
security goals should be, is an important part of this paper.
%

%-------------------------------------------------------------------------- sub
\subsection{Contributions}
\label{sec:contributions}
We have reviewed and analyzed the \mEdhoc{} protocol, which has continuously
evolved, at times based on our feedback.
%
The analysis spanned over roughly five months, but the formal models and proven
properties are based on to the version specified in the draft as it was on
2020-03-01~\cite{selander-lake-edhoc-01}.
%

Our main contributions are the following.
\begin{itemize}
    \item We provide formalization of all five cryptographic cores of \mEdhoc{}
        using \mTamarin~\cite{DBLP:conf/cav/MeierSCB13}.
    \item We give an explicit security model for the protocol and have verified
        essential security properties, such as session key and entity
        authentication, as well as Perfect Forward Secrecy (PFS), within that
        model.
        From these explicitly proven properties other properties follow, e.g.,
        session key independence.
    \item We discuss the relation between proven properties, potentially missing
        properties and the lack of clear design goals and security model for
        \mEdhoc{}.
        Based on this we give recommendations for the future standards
        development in regards to clarity, not only in terms of under which
        technical restrictions the protocol must work, but also what its
        envisioned uses are.
    \item Our discussions with members of the IETF LAKE working group have already
        lead to improvements and clarifications of the standard \mSpec{} based
        on observations we made during the construction of our formal model.
\end{itemize}

%-------------------------------------------------------------------------- sub
\subsection{Related work}
\label{sec:relatedWork}
The work closest to ours is Bruni~et.~al.~\cite{DBLP:conf/secsr/BruniJPS18},
which used \mProverif~\cite{DBLP:conf/csfw/Blanchet01} to analyze an earlier,
two-cryptographic core, version of \mEdhoc~\cite{selander-ace-cose-ecdhe-08}.
%
We consider our work to be a sort of follow-up to that, doing a similar kind of
analysis of the most recent, and more elaborate, version of \mEdhoc{} with its
five cores.
%
We do, however, take a clean slate approach and look at the protocol as new.
%
For example, since the model has undergone so much change, the set of properties
which we verify is also different.
%
The \mTamarin{} tool has been used to verify many other protocols, perhaps
closest to our work is Cremers~et.~al's analysis of
\mTls~\cite{DBLP:conf/ccs/CremersHHSM17}.
%
Some of the cryptographic cores themselves have been analyzed in the
computational model, e.g., \mSigma{} by Canetti and
Krawczyk~\cite{DBLP:conf/crypto/CanettiK02}, \mOptls{} by Krawczyk and
Wee~\cite{DBLP:conf/eurosp/KrawczykW16}, and \mNoise{} by
Kobeissi~et.~al.~\cite{DBLP:conf/eurosp/KobeissiNB19}.
%
Computational models often rely on implicit session key authentication
(see for example the definition of SK-security in the Canetti-Krawczyk
model~\cite{DBLP:conf/crypto/CanettiK02}).
%
Although symbolic models predominantly rely on correspondence properties in the
style of Lowe~\cite{DBLP:conf/csfw/Lowe97a}, there are examples where implicit
authentication has been used.
%
For example, Schmidt~et.~al.~\cite{DBLP:conf/csfw/SchmidtMCB12} use a
symbolized version of an extended Canetti-Krawzcyk model.
%

%-------------------------------------------------------------------------- sec
\section{The \mEdhoc{} protocol}
\label{sec:edhoc}
\input{edhocProtocol}

%-------------------------------------------------------------------------- sec
\section{Formalization and results}
\label{sec:formalization}
\input{edhocFormalization}

%-------------------------------------------------------------------------- sec
\section{Discussion}
\label{sec:discussion}
%-------------------------------------------------------------------------- sub
There are a few instances where things are ill-specified in the \mSpec{}, which we found as part of this work. We discuss them below. 

\subsection{Security claims}
\label{sec:securityClaims}
The \mSpec{} makes detailed claims about security properties that \mEdhoc{} enjoys. In particular, in Section~8.1 of~\cite{selander-lake-edhoc-01}, the authors claim that ``EDHOC inherits its security properties from the theoretical SIGMA-I''. While it is good practice to reuse well-studied academic components to design a standard, it is important to justify that any changes made still preserve the security properties enjoyed by the component. It is inadvisable for the \mSpec{} to make claims about security properties without any analysis to back this up.   

\subsection{Lack of clear use-cases}
\label{sec:unclearProtocolUse}
Formal verification aims to verify whether well-specified security goals hold for particular security models, defined in terms of attacker capabilities, assumptions on storage and processing by parties etc. Without a clear picture of the intended uses of the protocol, it cannot be determined which properties are the most important ones for constrained IoT applications.

Much like \mDandTls{}, \mEdhoc{} is intended for a variety of use cases,
many of which are not even known today. However, one can still collect a variety of \emph{typical} use cases and user stories. Having a better understanding of the security properties required by these use cases would help define a clearer security model, and thus guide the design of \mEdhoc{}. For example, one might be able to reduce the number of methods to only a few that are needed.

While constructing our model, we came up with simple user stories to identify security properties of interest. Several of these revealed undefined aspects of \mEdhoc{} that were then included in the \mSpec. We present below a couple of examples.

\subsubsection{Credentials stored in a trusted execution environment (TEE)}
Does one need to consider applications of \mEdhoc{} where the device is
deployed in a hostile environment, and might be equipped with a TEE? We received indications from the \mSpec{} authors (personal correspondence) that it was not necessary to consider revealing of the ephemeral secret keys, i.e. not necessary to consider compromised TEEs. 

The rationale is that \mSigma{} cannot protect against such an attack (presumably based on the fact that the \mSigSig{} method is closely based on \mSigmaI{} and that it would be preferable to obtain some kind of homogeneity among the \mEdhoc{} methods when it comes to what security properties they provide). \vnote{Speculation?}
%
That argument is only true, however, if one restricts attention to session key confidentiality of an ongoing session. TEEs do provide value by, for example, allowing weak PCS guarantees. Furthermore, in the \mStat{}-based methods, a static long-term key and an ephemeral one are mixed to obtain the session key material. This design is intentional, especially in the \mOptls{} case, where the protocol is designed to be provably secure in the Canetti-Krawczyk model. \vnote{So?}
%

\subsubsection{Non-repudiation}
An access control solution for a nuclear power-plant may need to log who is passing through a door, whereas it may be undesirable for, say, a coffee machine to log a list of users along with their coffee preferences. Via this simple thought experiment, we realized that the \mSpec{} did not
consider non-repudiation. In response, the authors of the \mSpec{} added a paragraph about which methods provided which types of (non)-repudiation.

\subsubsection{Peer authentication}
Section 3.2 of the \mSpec{} states that parties must be configured
with a policy restricting the set of peers they can run \mEdhoc{} with. However, the initiator is not required to verify that the \mIdcredr{} received in message 2 is the same as the one intended at initialization. The following thought experiment shows why such a policy is insufficient.

Assume that someone has configured all devices in their home to be in the allowed set of devices, but that one of the devices ($A$) has since been compromised. If another device $B$, unaware of the compromise, initiates a connection to a third device $C$, the compromised device $A$ may interfere. $A$ may respond in $C$'s place, blocking the legitimate response from $C$. Since $B$ does not verify $C$'s identity in message 2, and device $A$ is part of the allowed set, $B$ will complete and accept the \mEdhoc{} run with device $A$ instead of the intended $C$. The obvious solution is for the initiator to match \mIdcredr{} to the intended identity provided by the application. \vnote{Has this been pointed out to the authors of the \mSpec?}

%-------------------------------------------------------------------------- sub
\subsection{Session key material}
\label{sec:sessionKeyMaterial}
\mEdhoc{} establishes a session key state as output, from which session keys for \mOscore{} can be derived using \mHkdf{}. As discussed in Section~\ref{sec:threat-model}, there are various possibilities for defining which parameters from the \mEdhoc{} run should be included in the session key state.

While we show bidirectional injective agreement on \mGx{} and \mGy{}
for all methods, initiators cannot obtain injective agreement on \mGiy{} when using the \mStat{} method themselves. Therefore, \mGiy{} cannot be considered part of the key material if mutual injective agreement is considered important. Excluding \mGiy{} would deviate from \mOptls{}, which is the cryptographic core used for the \mStat-based methods. Specifically, the proof of session key confidentiality in the face of long-term key compromise for \mOptls{} cannot be adapted for \mEdhoc{}. Other security properties of \mOptls{} may also fail to be true if
\mGiy{} were excluded. \textbf{Conjecture.}
%

This can be avoided by including a fourth message from responder to initiator carrying a message authentication code using a key derived from session key material including \mGiy{}. This would give the initiator sufficient guarantees about the same \mGiy{} being used by the responder as well. However, the cost is an additional message, and our understanding is that this is unacceptable (personal correspondence with the \mSpec{} authors).
%
In some use cases there could be a such as message as part of
the subsequent \mOscore{} protocol run. It would, however, create an additional dependency between the two protocols, increasing complexity and the risk of insecure implementations.

Yet another option is to include \mGi{}, or a hash of it, in messages one and two. This would, however, increase message sizes, a grave concern for \mEdhoc{}, and would also prevent initiator identity protection. While identity protection is important in general, neither the \mSpec{} nor the requirements document give any rationale why one identity (the intiator's) is deemed more important (and needs protection) than the other (the responder's). So perhaps this method can be used to obtain injective agreement on \mGiy. 

%
%The \mSpec{} states that the initiator's identity is protected against active attacks and the responder's against passive attacks, but that the roles should be assigned to the \mCoap{} peers to protect the most sensitive identity the most (see Section~8~\cite{selander-lake-edhoc-01}).
%
%Roles could hence be swapped, so identity protection is not a strong argument against this option.
%
In this work, we have shown implicit agreement on \mGx{}, \mGy{} for all methods, and also on \mGiy{} and \mGrx{} when these are used, see Section~\ref{sec:formalization}. If this weaker security guarantee is sufficient, both ephemeral and long-term keys can be part of the session key material. However, this also depends on the intended use of \mEdhoc{}.
%

%-------------------------------------------------------------------------- sub
\subsection{Cipher suite negotiation}
\label{sec:ciphersuiteNegotiation}
%
Cipher suite negotiation in \mEdhoc{} spans two or more executions of the protocol. If a run terminates due to the proposed cipher suites being rejected by the responder, the initiator maintains state and initiates a new run, proposing an updated set of cipher suites (see Section~\ref{sec:edhoc}). Our model does not cover this, and we leave it for future work.

Maintaining state between protocol runs implicitly creates a long-lived meta-session covering multiple \mEdhoc{} sessions. Such a meta-session is presumably controlled by the underlying application. However, the \mSpec{} does not specify the time for which the initiator should remember a rejected cipher suite for a given responder.

%
From a security perspective, remembering the rejected cipher suite for the
next \mEdhoc{} run in the same meta-session would be sufficient. If the responder is updated with a new cipher suite before the next such session, this could be taken into account. On the other hand, caching the rejected cipher suite between meta-sessions would reduce the number of round-trips for subsequent runs, should the responder not have been updated. This needs to be clearly specified. 

%-------------------------------------------------------------------------- sec
\section{Conclusions}
\label{sec:conclusions}
We have formally modeled all the five
methods of the \mEdhoc{} key establishment protocol using the \mTamarin{} tool.
%
Using the model, we identified and defined several important security properties
and verified these.
%
We also identified security properties that does not hold for all
methods.
%
Most importantly, injective agreement on \mGiy{} does not hold for
initiators when they use the \mStat{} method, so this property cannot be claimed
for the entire key material in those situations.
%
Further, we identified a situation where initiators may establish an \mOscore{}
security context with a different party than the application using \mEdhoc{}
intended, and proposed a simple mitigation.
%
We discussed possible actions that IETF may take to extract and better define
security properties to make better use of verification techniques.
%

%-------------------------------------------------------------------------- ack
% Should be a run-in heading.  subsubsection works in llncs2e document class
\subsubsection*{Acknowledgments} This work was partially supported by
the Wallenberg AI, Autonomous Systems and Software Program (WASP) funded by
the Knut and Alice Wallenberg Foundation.
%
We are grateful to G\"oran Selander, John Mattsson and Francesca Palombini for
clarifications regarding the specification.
%

%-------------------------------------------------------------------------- bib
\bibliographystyle{plain}
\bibliography{ref}
\end{document}
